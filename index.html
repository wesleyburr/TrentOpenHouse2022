<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Magnetograms: Digitization and Code</title>
    <meta charset="utf-8" />
    <meta name="author" content="Wesley S. Burr – Trent University     wsburr     @wsburr    wesleyburr@trentu.ca  " />
    <meta name="date" content="2021-03-29" />
    <script src="libs/header-attrs-2.7/header-attrs.js"></script>
    <script src="https://use.fontawesome.com/5235085b15.js"></script>
    <link rel="stylesheet" href="example.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Magnetograms: Digitization and Code
### Wesley S. Burr – <a href="http://www.trentu.ca/math/">Trent University</a> <br> <a href="http://github.com/wesleyburr"><i class="fa fa-github fa-fw"></i>  wsburr</a><br> <a href="http://twitter.com/wsburr"> <i class="fa fa-twitter fa-fw"></i>  <span class="citation">@wsburr</span></a><br> <a href="mailto:wesleyburr@trentu.ca"><i class="fa fa-paper-plane fa-fw"></i>  wesleyburr@trentu.ca</a><br><br/>
### 2021-03-29

---


class: inverse



## A Brief History

* magnetic fields are generated by moving electric particles
* the Earth has a magnetic field
* this field varies across the surface and sub-surface and atmosphere of
the Earth
* observations of the magnetic field are useful for all sorts of 
physical science applications

---

class: inverse

## In Canada

* original magnetic observatory was in Toronto, founded in 1840
* the electrification of the Toronto tramway system resulted in interference,
and the observatory was moved to Agincourt in 1897
* the Agincourt Observatory was in continuous operation from 1898 to 1969,
but had to be closed due to industrial development and highway construction
* the Ottawa observatory (south of Ottawa, near Mer Bleue) was opened in July 1968, and has been in continuous operation since
* ... may need to be moved soon, as the O-Train extension is starting to inch closer and closer!

---

## The Observatory

&lt;center&gt;
&lt;img src="./figure/OTT-2007.jpg" style="width:600px;"/&gt;
&lt;/center&gt;


---

class: inverse

## What Kind of Data is this?

Time series!

- The fluxgate magnetometer samples the magnetic field at 8 Hz
- Three component data streams
- Filtered, resampled at 1 Hz
- Further filtered and resampled at 0.2 Hz (5 seconds)
- Finally, filtered and resampled to 1 minute intervals

The four 1-minute data streams are passed to the transmitter to be relayed in bursts at 12 minute intervals via a GOES satellite to various data nodes.

---

class: inverse

## Project Progression and Contributors

Dr. David Boteler, head of the National Resources Canada Geomagnetic Observatory staff, contacted Dr. David Thomson and team at Queen's University to see if they could help digitize the original records from the previous iterations, before digitized records began in the 1970s.

---

## An Example of One Sample

&lt;center&gt;
&lt;img src="./figure/magneto1.png" style="width:900px;"/&gt;
&lt;/center&gt;

---

class: inverse

## Project Progression and Contributors

* Dr. Aaron Springford, David Riegert: original proof of concept code, designed normalization algorithm
* (unnamed) summer students at Queen's: manual work of scanning the 35mm microfilm records
* Mark Weygang (MSc AMOD, Trent): extended algorithm, digitized 1/2 the corpus
* Ben Ott (summer research, Trent): refined codebase, finished extension of algorithm, designed Shiny front-end

---


## What Does a Magnetic Field Observation Look Like?

&lt;center&gt;
&lt;img src="./figure/magneto2.png" style="width:1200px;"/&gt;
&lt;/center&gt;

---

class: inverse

## How Did We Do This?

* start by flipping the colours and de-compressing the image
    - since the data was observed via an optical lens, there's an Airy disc-like scattering effect
    - use a Gaussian filter model for the scattering, inverse function
    - normalize the data range in the image to prevent oversaturation

---

class: inverse

## How Did We Do This?

* unsupervised learning (initially developed by Mark Weygang)
    - scan the image for a "top line"
    - scan the image for a "bottom line"
    - attempt to insert a line between the two signals
    - use a dynamic step scan, point-to-point, to try to trace out the signals, one at a time
    - attempt to determine start and end
* produces the red fit lines of the next image

---

class: inverse

## Unsupervised Fitting


&lt;center&gt;
&lt;img src="./figure/magneto3.png" style="width:1500px;"/&gt; 
&lt;br /&gt;
&lt;img src="./figure/magneto4.png" style="width:250px;"/&gt; 
&lt;img src="./figure/magneto5.png" style="width:250px;"/&gt; 
&lt;/center&gt;

---

class: inverse

## Issues

* not all images are so nicely behaved
    - lines can cross, or jump off page
    - detecting the start and end is tricky
    - no way of knowing if the unsupervised fit is "correct"
* there's a lot of images ...
    - if something breaks, how do we know what it was?
    - code quality ...
    
---

class: inverse

## Supervised Learning

* follow up with a human eyeball (Mark I)
* are the fits accurate through the center?
* are the fits starting at the correct column / pixel?
* are the fits ending at the correct column / pixel?
* do any of the traces intersect / cross? does the algorithm track this?

---

class: inverse

## Some Examples (1)

&lt;center&gt;
&lt;img src="./figure/issue1.png" style="width:1500px;"/&gt; 
&lt;/center&gt;

Ben Ott developed a better envelope algorithm in summer 2020 (green lines),
which helps understand intersections and flag them. It also prevents a lot
of the "wandering" that previously happened.

---

class: inverse

## Some Examples (2)

&lt;center&gt;
&lt;img src="./figure/issue2.png" style="width:1500px;"/&gt; 
&lt;/center&gt;

Example of the center line unsupervised fit, using the envelopes as
guides.

---

class: inverse

## Some Examples (3)

&lt;center&gt;
&lt;img src="./figure/issue3.png" style="width:1500px;"/&gt; 
&lt;/center&gt;

Example of an issue where the envelope fit and therefore the trace
are both pulled up suddenly by the detection of text as signal.
(Each image has handwriting on it to note things like date, time,
special events, etc.).

---

class: inverse

## Some Notes

* this doesn't seem, on the surface, like that big of a problem
* turns out, it's actually really tricky (to the point that Oxford astrophysicists just threw up their hands and gave up, re: the Greenwich versions of the same sort of data)
* supervised can only take you so far ... at some point, you need a human in the loop

---

class: inverse

## Shiny

* built on top of R, using a reactive interface using JavaScript
* easy development of dynamically interactive web applets, running R on the back-end
* naturally suited to a project that already has been built to run on R

---

class: inverse

## Quick Demo

* [Link to Demo](http://shiny.wesleyburr.com/magneto/)

* can manually intervene for any of the following:
    - top trace envelopes (top/bottom)
    - second trace envelopes (top/bottom)
    - note that there actually 3 traces
    - start and end of any traces
    - upper and lower data range clips 

Intervening like this is good enough to fix 95% of the remaining issues.
The rest will require manual intervention all the way along, as they are things like 3 interlaced traces, with a poorly developed image, and text written overtop. A general-purpose algorithm can't handle that.

---

class: inverse

## Left To Do

* a thesis (MSc or part of a PhD) in the statistical detection of timing ticks, and errors in the time steps of a time series
* aggregating and time-stamping all of the observations obtained via the digitization
* interpolating missing or damaged areas / regions / times
* determining vertical scale factors

---

class: inverse

## Why Care?

* this is a really cool data set!
* very, very old - data back to the 1840s!
* magnetic fields are known to be tightly coupled with sunspots, and solar activity: this gives us a proxy for climate change data!
* calibration of other retrospective data sets for climate and space, e.g., tree rings, sunspots, solar F10.7 activity
* the challenge is also pretty cool ...


---

class: inverse

## Closing Remarks

* always interested in having people contribute to this, although currently there's no funding from NRCan
* several MSc theses left in some of the tricky bits putting it all together
* probably another MSc in the pure analysis of the resulting corpus of data
* could definitely be small aspects suitable for 4800H if you're interested ...
* stats is pretty broad!


---

layout: false
class: inverse, middle

&lt;center&gt;
&lt;a href="http://www.trentu.ca/math/"&gt;&lt;img src="figure/trent.png" style="width: 200px;"/&gt;&lt;/a&gt; &amp;emsp;&amp;emsp;
&lt;a href="https://creativecommons.org/licenses/by/4.0/"&gt;&lt;img src="figure/cc.png" style="width: 200px;"/&gt;&lt;/a&gt;
&lt;/center&gt;

- Contact me: [Email](mailto:wesleyburr@trentu.ca) or [Twitter](https://twitter.com/wsburr)
- Slides created via the R package [xaringan](https://github.com/yihui/xaringan) by Yihui Xie
- Slides available at [GitHub](https://wesleyburr.github.io/TrentSeminar2021/#1)
&lt;br/&gt;
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "tomorrow-night-bright",
"highlightLines": true,
"highlightLanguage": "r"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
